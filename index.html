<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <h2 class="mb-4">Attendance Form</h2>
                
                <div id="qrScanner" class="mb-4">
                    <div id="scanner"></div>
                    <p class="text-muted">Scan the QR code to submit attendance</p>
                </div>

                <div id="attendanceForm" class="mb-4" style="display: none;">
                    <form id="attendanceForm" onsubmit="formApp.submitAttendance(event)">
                        <div class="mb-3">
                            <label for="studentId" class="form-label">Student ID</label>
                            <input type="text" class="form-control" id="studentId" required>
                        </div>
                        <div class="mb-3">
                            <label for="studentName" class="form-label">Student Name</label>
                            <input type="text" class="form-control" id="studentName" required>
                        </div>
                        <div class="mb-3">
                            <label for="section" class="form-label">Section</label>
                            <input type="text" class="form-control" id="section" required>
                        </div>
                        <button type="submit" class="btn btn-primary" id="submitBtn">Submit Attendance</button>
                    </form>
                </div>

                <div id="message" class="alert alert-info" role="alert" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Form application object
        const formApp = {
            currentSessionId: null,
            currentToken: null,
            deviceId: null,
            
            async init() {
                try {
                    // Initialize device ID
                    this.deviceId = localStorage.getItem('deviceId') || crypto.randomUUID();
                    localStorage.setItem('deviceId', this.deviceId);

                    // Initialize QR scanner
                    const scanner = new Html5Qrcode("scanner");
                    scanner.start({
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    }, false, this.onScanSuccess, this.onError);
                } catch (error) {
                    console.error("Error initializing form:", error);
                    this.showMessage("Failed to initialize form", "danger");
                }
            },

            onScanSuccess(decodedText) {
                const data = JSON.parse(decodedText);
                this.currentSessionId = data.sessionId;
                this.loadSession();
            },

            onError(err) {
                console.error("QR code scan error:", err);
                this.showMessage("QR code scan error", "danger");
            },

            async loadSession() {
                try {
                    const sessionRef = firebase.database().ref(`sessions/${this.currentSessionId}`);
                    const sessionSnap = await sessionRef.once('value');
                    const session = sessionSnap.val();

                    if (!session || !session.active) {
                        this.showMessage("Session not found or inactive", "danger");
                        return;
                    }

                    // Get current IP and TA IP
                    const currentIP = await fetch('https://api.ipify.org?format=json')
                        .then(res => res.json())
                        .then(data => data.ip)
                        .catch(() => 'unknown');

                    const taIpSnap = await firebase.database().ref(`sessions/${this.currentSessionId}/taIP`).once('value');
                    const taIP = taIpSnap.val();

                    if (currentIP === taIP) {
                        this.showMessage("⚠️ TA device cannot submit attendance.", "danger");
                        document.getElementById('submitBtn').disabled = true;
                        return;
                    }

                    // Check token availability and assign
                    const tokenSnap = await firebase.database().ref(`sessions/${this.currentSessionId}/tokens`).once('value');
                    const tokens = tokenSnap.val() || {};

                    let assignedToken = null;

                    // Try reusing existing token
                    for (const [key, data] of Object.entries(tokens)) {
                        if (data.issuedToDevice === this.deviceId) {
                            assignedToken = { key, data };
                            break;
                        }
                    }

                    // Assign new token if available
                    if (!assignedToken) {
                        const available = Object.entries(tokens).find(([_, d]) => !d.issuedToDevice);
                        if (available) {
                            const [token, data] = available;
                            const newData = {
                                ...data,
                                issuedToDevice: this.deviceId,
                                issuedToIP: currentIP,
                                issuedAt: Date.now()
                            };
                            await firebase.database().ref(`sessions/${this.currentSessionId}/tokens/${token}`).set(newData);
                            assignedToken = { key: token, data: newData };
                        } else {
                            this.showMessage("❌ No tokens available. Attendance is closed.", "danger");
                            document.getElementById('submitBtn').disabled = true;
                            return;
                        }
                    }

                    this.currentToken = assignedToken.key;
                    document.getElementById('qrScanner').style.display = 'none';
                    document.getElementById('attendanceForm').style.display = 'block';
                } catch (error) {
                    console.error("Error loading session:", error);
                    this.showMessage("Failed to load session", "danger");
                }
            },

            async submitAttendance(event) {
                event.preventDefault();
                
                try {
                    const studentId = document.getElementById('studentId').value;
                    const studentName = document.getElementById('studentName').value;
                    const section = document.getElementById('section').value;
                    
                    const tokenPath = `sessions/${this.currentSessionId}/tokens/${this.currentToken}`;
                    const tokenSnap = await firebase.database().ref(tokenPath).once('value');
                    const tokenData = tokenSnap.val();

                    // Check token misuse
                    const isTokenMisused = tokenData.used;
                    const isSecondUser = tokenData.id !== studentId;

                    if (isTokenMisused && isSecondUser) {
                        await firebase.database().ref(`${tokenPath}/flagged`).set(true);
                        await firebase.database().ref(`${tokenPath}/secondStudentId`).set(studentId);

                        await firebase.database().ref(`sessions/${this.currentSessionId}/attendees`).push({
                            id: studentId,
                            name: "Flagged Submission",
                            timestamp: Date.now(),
                            ip: tokenData.issuedToIP,
                            token: this.currentToken,
                            flagged: true,
                            note: `Same token with ${tokenData.id}`
                        });

                        this.showMessage("⚠️ Token already used by another student. Your attendance was not counted.", "danger");
                        document.getElementById('submitBtn').disabled = true;
                        return;
                    }

                    // Mark token as used
                    await firebase.database().ref(`${tokenPath}/used`).set(true);
                    await firebase.database().ref(`${tokenPath}/id`).set(studentId);
                    await firebase.database().ref(`${tokenPath}/name`).set(studentName);

                    // Record attendance
                    await firebase.database().ref(`sessions/${this.currentSessionId}/attendees`).push({
                        id: studentId,
                        name: studentName,
                        section: section,
                        timestamp: Date.now(),
                        ip: tokenData.issuedToIP,
                        token: this.currentToken
                    });

                    this.showMessage("Attendance submitted successfully!", "success");
                    document.getElementById('attendanceForm').reset();
                    
                    // Reset form after 2 seconds
                    setTimeout(() => {
                        document.getElementById('qrScanner').style.display = 'block';
                        document.getElementById('attendanceForm').style.display = 'none';
                        this.currentToken = null;
                        document.getElementById('submitBtn').disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error("Error submitting attendance:", error);
                    this.showMessage("Failed to submit attendance", "danger");
                }
            },

            showMessage(message, type = "info") {
                const messageDiv = document.getElementById('message');
                messageDiv.className = `alert alert-${type}`;
                messageDiv.textContent = message;
                messageDiv.style.display = 'block';
                
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        };

        // Initialize the form app
        formApp.init();
    </script>
</body>
</html>
